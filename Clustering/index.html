<!DOCTYPE html>

<html lang="en">
<head>
<!-- This is a file which adds the chloropleth layer -->
    <script type="text/javascript" src="us-states.js"></script>

<!-- Basic jquery and leaflet javascript,css and boot strap files -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.3/leaflet.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.0-beta.2.rc.2/leaflet.css"/>
    
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.3/leaflet.css" />
    


<!-- Add the title to the page -->
    <meta charset="utf-8" />
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, target-densitydpi=device-dpi" />
    <title>Mapping.Community</title>

<!-- Files for prune clustering -->
    <script src="js/PruneCluster.js"></script>
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
     
<!-- Links required for cartoDB -->    
    <script src="http://libs.cartocdn.com/cartodb.js/v3/3.15/cartodb.js"></script>

<!--Leaflet sidebar javascript and css files--> 
    <script src="js/leaflet-sidebar.js" type="text/javascript"></script>
    <script type="text/javascript">
        window.heap=window.heap||[],heap.load=function(e,t){window.heap.appid=e,window.heap.config=t=t||{};var r=t.forceSSL||"https:"===document.location.protocol,a=document.createElement("script");a.type="text/javascript",a.async=!0,a.src=(r?"https:":"http:")+"//cdn.heapanalytics.com/js/heap-"+e+".js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(a,n);for(var o=function(e){return function(){heap.push([e].concat(Array.prototype.slice.call(arguments,0)))}},p=["addEventProperties","addUserProperties","clearEventProperties","identify","removeEventProperty","setEventProperties","track","unsetEventProperty"],c=0;c<p.length;c++)heap[p[c]]=o(p[c])};
          heap.load("315187443");
    </script>
    <link rel="Stylesheet" href="css/sideBar.css" type="text/css" />
    <link rel="Stylesheet" href="css/mystyle2.css" type="text/css" />

 </head>
<body>



  <div id="page-content">
        <section class="main-content">
            <div class="container-wide">  
                <div style="height: 575px;"> 
                    <div id="sidebar" class="sidebar collapsed">
                        <!-- Nav tabs -->
                        <div class="sidebar-tabs">
                            <ul role="tablist">
                                <li><a href="#home" role="tab"><i class="fa fa-pencil"></i></a></li>
                                <!--<li><a href="#profile" role="tab"><i class="fa fa-user"></i></a></li>
                                <li class="disabled"><a href="#messages" role="tab"><i class="fa fa-envelope"></i></a></li>--> 
                            </ul>

                            <ul role="tablist">
                                <!--   <li><a href="#settings" role="tab"><i class="fa fa-gear"></i></a></li> -->   
                            </ul>
                        </div>

                        <!-- Tab panes -->
                        <div class="sidebar-content">
                            <div class="sidebar-pane" id="home">
                                <h1 class="sidebar-header">
                                    Sidebar
                                    <span class="sidebar-close"><i class="fa fa-caret-right"></i></span>
                                </h1>
                                <p id="sidebar-text"></p>
                             </div>
                        </div> <!--end div classs="sidebar-content"-->
                    </div>
                    <div id='map' class="sidebar-map"></div>
                </div>
            </div>
        </section>
    </div>

    <script>




        //Add the map to the page with all the features note zoom control is used here which adds a zoom icon however below L.control.zoom can be used and add more detailed functionality  
    var map = L.map("map", {
                attributionControl: false,
                zoomControl: false,
    }).setView(new L.LatLng(55.3781, -4.4360), 9);

    L.control.zoom({
       position:'topleft'
    }).addTo(map);

      //Adds the layer of the map which can be changed by altering the png file
    L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
        detectRetina: true,
        maxNativeZoom: 5
    }).addTo(map);



  var sidebar = L.control.sidebar('sidebar', {
    position: 'right'
    });

    map.addControl(sidebar);


    function openSidebar(network, ID,url,facebook_url,twitter_url,description) {           
            
            //This adds a parser funcionality if the input from the database contains errors needed to change the url formatting if incorrect in the database
            var parser = document.createElement('a');
            parser.href = url;
            parser.protocol; // => "http:"
            parser.hostname; // => "example.com"
            parser.port;     // => "3000"
            parser.pathname; // => "/pathname/"
            parser.search;   // => "?search=test"
            parser.hash;     // => "#hash"
            parser.host; // => "example.com:3000"

            //This is functionality for entries that are incorrect which alters the url so that it becomes a link and adds https://
            if(url != null && parser.protocol != "http://" && network == "Community Land Scotland"){
              //alert(network);
              url = "http://" + url;
              //alert(url)
            }


            //This is to format the length of the text in the sidebar
            if(url == null){
              url1 = "";
            } else if (url.length > 20){
                //parse and remove 
               
                url1 = parser.hostname;
                
            } else{
                url1 = parser.host;
            }

             if(twitter_url == undefined){
                   
                sidebar.open('home');
              var divToAddContent = document.getElementById('home');
              
              //This information is what is displayed in the pop out.
               divToAddContent.innerHTML = "<b>" + network + "</b>" + "</br></br>" + "<b>Name: </b>" + ID + "</br>" + "<b>Url: </b>" +
              '<a href="'+ url + '" target="_blank"' + '>' + url1 + '</a>' + "</br><b>Description:</b> " + description
              +"</br></br></br></br>"+ "KNN placement:";
            }
            else if(url == undefined || url == null || url == ""){



              sidebar.open('home');
              var divToAddContent = document.getElementById('home');
              
              //This information is what is displayed in the pop out.
              divToAddContent.innerHTML = "<b>" + network + "</b>" + "</br></br>" + "<b>Name: </b>" + ID +  "</br><b> Facebook: </b>" + facebook_url+ "</br><b>Description:</b> " + description
              +"</br></br></br></br>"+ "KNN placement:";

            //(twitter_url == null){
               
              
            }else if (facebook_url == undefined){

                   sidebar.open('home');
              var divToAddContent = document.getElementById('home');
              
              //This information is what is displayed in the pop out.
                divToAddContent.innerHTML = "<b>" + network + "</b>" + "</br></br>" + "<b>Name: </b>" + ID + "</br>" + "</br><b>Description:</b> " + description
              +"</br></br></br></br>"+ "KNN placement:";
            }

            //This removes previous text upon updating the side bar
              if ($('#sidebar-text').text().length > 0) {
                  $("#sidebar-text").removeText();
              }

              /*for (var i = 0, len = results.length; i < len; i++) {
                   
               //this loop matches the array element to the passed ID  
                  if (results[i].Link == ID) {
                      thisResult = (results[i]);            
                  }
              }
              */
              //remove name from thisResult and others
            
          }


          //Adds the prune cluster view for leaflet so other items can be added to it. Refer to prune cluster docs for more info
          //Find prunecluster docs at https://github.com/SINTEF-9012/PruneCluster
          //This is boilerplate code taken from the examples on the prunecluster library
    var leafletView = new PruneClusterForLeaflet();

    


    //Adds prune cluster functionality for the page
    leafletView.BuildLeafletClusterIcon = function(cluster) {
        var e = new L.Icon.MarkerCluster();

        e.stats = cluster.stats;
        e.population = cluster.population;
        return e;
    };

    var colors = ['#ff4b00', '#bac900', '#EC1813', '#55BCBE', '#D2204C', '#FF0000', '#ada59a', '#3e647e'],
        pi2 = Math.PI * 2;

    L.Icon.MarkerCluster = L.Icon.extend({
        options: {
            //This had an error as it was trowing off the marker alignment so had to be reduced
            iconSize: new L.Point(80, 50),
            className: 'prunecluster leaflet-markercluster-icon'
        },

        createIcon: function () {
            // based on L.Icon.Canvas from shramov/leaflet-plugins (BSD licence)
            var e = document.createElement('canvas');
            this._setIconStyles(e, 'icon');
            var s = this.options.iconSize;
            e.width = s.x;
            e.height = s.y;
            this.draw(e.getContext('2d'), s.x, s.y);
            return e;
        },

        createShadow: function () {
            return null;
        },

        draw: function(canvas, width, height) {

            var lol = 0;

            var start = 0;
            for (var i = 0, l = colors.length; i < l; ++i) {

                var size = this.stats[i] / this.population;


                if (size > 0) {
                    canvas.beginPath();
                    canvas.moveTo(22, 22);
                    canvas.fillStyle = colors[i];
                    var from = start + 0.14,
                        to = start + size * pi2;

                    if (to < from) {
                        from = start;
                    }
                    canvas.arc(22,22,22, from, to);

                    start = start + size*pi2;
                    canvas.lineTo(22,22);
                    canvas.fill();
                    canvas.closePath();
                }

            }

            canvas.beginPath();
            canvas.fillStyle = 'white';
            canvas.arc(22, 22, 18, 0, Math.PI*2);
            canvas.fill();
            canvas.closePath();

            canvas.fillStyle = '#555';
            canvas.textAlign = 'center';
            canvas.textBaseline = 'middle';
            canvas.font = 'bold 12px sans-serif';

            canvas.fillText(this.population, 22, 22, 40);
        }
    });



    var size = 10000;
    var markers = [];


    //These are the additional datasets which will be added to the prune clustering, the marker.category needs to be altered along with the marker name/number to prevent duplicates 
    //The getJSON call is used which requires specific url for your carto account ad then a specific sql call check the sql table name on carto as it may not be the same name as you uploaded from your original machine eg "mapcomm-admin".communityenergy_groups_gb_sct' was originally communityenergy_groups_gb_sct. Also, check the port number is correct.


/*
    var query2 = $.getJSON('https://carto.mapping.community:9090/user/hilld/api/v2/sql?format=GeoJSON&q=SELECT * FROM "mapcomm-admin".communityenergy_groups_gb_sct',     
    function(data2) {
             L.geoJSON(data2, {
                  pointToLayer: function (feature, latlng, properties) {
                    //console.log(latlng.lat, latlng.lng);
                    var marker2 = new PruneCluster.Marker(latlng.lat, latlng.lng);
                    marker2.category = 0;
                    markers.push(marker2);
                    leafletView.RegisterMarker(marker2);
                  }
            })
    });*/
/*
     var query3 = $.getJSON('https://carto.mapping.community:9090/user/hilld/api/v2/sql?format=GeoJSON&q=SELECT * FROM "mapcomm-admin".communityenergy_groups_gb_sct',     
    function(data1) {
             L.geoJSON(data1, {
                  pointToLayer: function (feature, latlng) {
                    //console.log(latlng.lat, latlng.lng);


                    var marker = new PruneCluster.Marker(latlng.lat, latlng.lng);
                   
                      
                    marker.category = 1;
                   // marker.category = Math.floor(Math.random() * colors.length);
                    markers.push(marker);
                    leafletView.RegisterMarker(marker);    
}
                  })

});

 var query4 = $.getJSON('https://carto.mapping.community:9090/user/hilld/api/v2/sql?format=GeoJSON&q=SELECT * FROM "mapcomm-admin".communityland_groups_gb_sct',     
    function(data1) {
        console.log(data1);
        L.geoJSON(data1, {
                  pointToLayer: function (feature, latlng) {
                    //console.log(latlng.lat, latlng.lng);
                    var marker3 = new PruneCluster.Marker(latlng.lat, latlng.lng, {color: '#222'});


                    marker3.category = 2;
                   // marker.category = Math.floor(Math.random() * colors.length);
                    markers.push(marker3);
                    leafletView.RegisterMarker(marker3);    
}
                  })

});   
*/

  var query3 = $.getJSON('https://carto.mapping.community:9090/user/hilld/api/v2/sql?format=GeoJSON&q=SELECT * FROM "mapcomm-admin".dtas_groups_gb_sct',     
    function(data1) {
        
        L.geoJSON(data1, {
                  pointToLayer: function (feature, latlng, properties) {


                    /*var myIcon = L.icon({
                       // iconUrl: 'pruneCluster.png',
                       iconUrl: 'leaflet.jpeg',
                        iconSize: [90, 95],
                        iconAnchor: [22, 94],
                        popupAnchor: [-3, -76],
                        //shadowUrl: 'my-icon-shadow.png',
                        shadowSize: [68, 95],
                        shadowAnchor: [22, 94]
                    });*/



                    var marker4 = new PruneCluster.Marker(latlng.lat, latlng.lng, {color: '#000', feature, 
                        'color': '#f3ff00', 'colorClass': 'yellow', 'visible':true,  icon: L.icon({
                iconUrl: 'leaflet.jpeg',
                iconSize: [48, 48]

            })
                    });

                 
                   


                    

                    marker4.category = 3;
                 //   marker.data.icon = L.icon(...); 


             /*   marker4.data.icon = L.icon({
                    options: {
                        iconUrl: 'leaflet.jpeg',
                        iconSize:     [38, 95],
                        shadowSize:   [50, 64],
                        iconAnchor:   [22, 94],
                        shadowAnchor: [4, 62],
                        popupAnchor:  [-3, -76]
                    }
                });

      
*/
                    


                    
                   // marker.category = Math.floor(Math.random() * colors.length);
                    markers.push(marker4);
                    leafletView.RegisterMarker(marker4); 

    }
                      })

    });   
        

  //An attemp to change the icons this is work in progress
      var  myIcon =           L.icon({
        iconUrl: 'leaflet.jpeg',
        iconSize: [38, 95],
        iconAnchor: [22, 94],
        popupAnchor: [-3, -76],
       
        shadowSize: [68, 95],
        shadowAnchor: [22, 94]
    });

      var  myIcon2 =           L.icon({
                         iconUrl: 'leaflet.jpeg',
        iconSize: [10, 25],
        iconAnchor: [22, 94],
        popupAnchor: [-3, -76],
       
        shadowSize: [68, 95],
        shadowAnchor: [22, 94]
                  });




//This section adds functionality to the cluster group which has an onhover(moueover), also an on click functionality
//These need to be added to the leaflet view 
leafletView.PrepareLeafletMarker = function(leafletMarker, data,properties) {


    if(data.feature.properties.network == "DTAS"){
       // leafletMarker.setIcon(myIcon2);
    }

       // leafletMarker.setIcon(myIcon2);
    
        
         leafletMarker.on('mouseover', function(e) {
            var popup = L.popup()

            .setLatLng(e.latlng) 
            .setContent( "<b>" + data.feature.properties.name + "</b>" + "</br>" + "</br>"  + "<i>Click for more information<i>")
            .openOn(map);
        });
   
    leafletMarker.on('mouseout', function (e) {
            map.closePopup();
        });

    leafletMarker.on('click', function(){
        
       console.log(data.feature.properties.network)
       openSidebar(data.feature.properties.network, data.feature.properties.name, data.feature.properties.url,data.feature.properties.facebook_url,data.feature.properties.twitter_url,data.feature.properties.description);
     
    //do click event logic here
    })

};

    map.addLayer(leafletView);


    //This is work in progress which is for the additional layers of the areas of deprivation in the uk using  amap box overlay 
    //This is work in progress
    //add the key token from mapbox 
   
    L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiZGFuaGlsbGNvZGUiLCJhIjoiY2o0dmR3aG1lMG05djMzbzE2dW42OHZkNSJ9.FC7U0-Wz5UBLBu45_w9c_w', {
        maxZoom: 18,
        attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
            '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
            'Imagery © <a href="http://mapbox.com">Mapbox</a>',
        id: 'mapbox.streets'
    }).addTo(map);


    // control that shows state info on hover
    var info = L.control();


//L.geoJson('us-states.js').addTo(map);


    info.onAdd = function (map) {
        this._div = L.DomUtil.create('div', 'info');
        this.update();
        return this._div;
    };

    info.update = function (props) {
        this._div.innerHTML = '<h4>US Population Density</h4>' +  (props ?
            '<b>' + props.name + '</b><br />' + props.density + ' people / mi<sup>2</sup>'
            : 'Hover over a state');
    };

    info.addTo(map);




    // get color depending on population density value
    function getColor(d) {
        return d > 1000 ? '#800026' :
                d > 500  ? '#BD0026' :
                d > 200  ? '#E31A1C' :
                d > 100  ? '#FC4E2A' :
                d > 50   ? '#FD8D3C' :
                d > 20   ? '#FEB24C' :
                d > 10   ? '#FED976' :
                            '#FFEDA0';
    }

    function style(feature) {
        return {
            weight: 2,
            opacity: 1,
            color: 'white',
            dashArray: '3',
            fillOpacity: 0.4,
            fillColor: getColor(feature.properties.density)
        };
    }

    function highlightFeature(e) {
        var layer = e.target;

        layer.setStyle({
            weight: 5,
            color: '#000',
            dashArray: '',
            fillOpacity: 0.7
        });

        if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
            layer.bringToFront();
        }

        info.update(layer.feature.properties);
    }

    var geojson;

    function resetHighlight(e) {
        geojson.resetStyle(e.target);
        info.update();
    }

    function zoomToFeature(e) {
        map.fitBounds(e.target.getBounds());
    }

    function onEachFeature(feature, layer) {
        layer.on({
            mouseover: highlightFeature,
            mouseout: resetHighlight,
            click: zoomToFeature
        });
    }

    //This is the input of the data for the layer and states data is in the javascript file us-states

    geojson = L.geoJson(statesData, {
        style: style,
        onEachFeature: onEachFeature
    }).addTo(map);

    map.attributionControl.addAttribution('Population data &copy; <a href="http://census.gov/">US Census Bureau</a>');




    //Functionality to add a legend to the map which is linked to the mapbox overlay however this may need to be changed at a later date
    var legend = L.control({position: 'bottomright'});

    legend.onAdd = function (map) {

        var div = L.DomUtil.create('div', 'info legend'),
            grades = [0, 10, 20, 50, 100, 200, 500, 1000],
            labels = [],
            from, to;

        for (var i = 0; i < grades.length; i++) {
            from = grades[i];
            to = grades[i + 1];

            labels.push(
                '<i style="background:' + getColor(from + 1) + '"></i> ' +
                from + (to ? '&ndash;' + to : '+'));
        }

        div.innerHTML = labels.join('<br>');
        return div;
    };

    legend.addTo(map);


    </script>     

</body>
</html>